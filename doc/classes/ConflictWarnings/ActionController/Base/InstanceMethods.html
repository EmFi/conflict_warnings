<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: ConflictWarnings::ActionController::Base::InstanceMethods</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">ConflictWarnings::ActionController::Base::InstanceMethods</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../../files/lib/conflict_warnings_rb.html">
                lib/conflict_warnings.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
These methods are used in <tt>filter_conflicts</tt> and
<tt>filter_resources_unavailable</tt> They are provided for use in your own
custom filters.
</p>
<p>
<tt><a href="InstanceMethods.html#M000003">catch_conflicts</a></tt> and
<tt><a
href="InstanceMethods.html#M000004">catch_resources_unavailable</a></tt>
identify problem cases based on their arguments, the parameters of the
current requests allowing you to display relevant errors and warnings
and/or more importantly update information.
</p>
<p>
<tt><a href="InstanceMethods.html#M000003">catch_conflicts</a></tt> and
<tt><a
href="InstanceMethods.html#M000004">catch_resources_unavailable</a></tt>
use timestamps and resources respectively to identify problem requests.
</p>
<p>
In either case, conflict_warnings will make reasonable guesses when options
are omitted.
</p>
<p>
For requests accepting html, the default action in the event of a conflict
is to <tt>redirect_to :back</tt>, reloading the referring page, and adding
the default warning message to <tt>flash[:warning]</tt>. For :js format
requests, the page is reloaded and an alert box displays the default
message. Currently conflict_warnings catch methods do not have default
actions for other formats. However, any block given to <tt><a
href="InstanceMethods.html#M000003">catch_conflicts</a></tt> or <tt><a
href="InstanceMethods.html#M000004">catch_resources_unavailable</a></tt>
will be executed in the event of a problem request.
</p>
<p>
If a request is identified as problematic, the status of the response is
409 Conflict, unless the supplied block states otherwise, or a template was
not found in a HTTP request. Some browsers will not follow a redirection
who&#8216;s status is not 302 Redirected.
</p>
<p>
Both of these methods return true if a request was interrupted, otherwise
they return false.
</p>
<h2>Common Options for catch_*</h2>
<p>
<tt><a href="InstanceMethods.html#M000003">catch_conflicts</a> *args,
options = {}, &amp;block</tt> <tt>catch_resources_unavilable *args, options
= {}, &amp;block</tt>
</p>
<p>
*args are passed to the accessor. The block is optional and will be
evaluated in place of the conflict_warnings default actions when a problem
request is identified. It should contain a respond_to block.
</p>
<p>
Accepted options:
</p>
<dl>
<dt><tt>:model</tt></dt><dd>ActiveRecord model that will be used to determine if there is a conflict.
Default value is derived from the current controller name. Can be a
provided, as a string, symbol, constant, or instance of ActiveRecord::Base.
If a record is supplied this option cannot be used with <tt>:id,
:params_id_key,</tt> or<tt> :find_options.</tt>

</dd>
<dt><tt>:id</tt></dt><dd>Record id used to determine if there is a conflict. Default value is
<tt>params[&quot;#{model)_id&quot;]</tt> if it extsts, with
<tt>params[:id]</tt> as a fallback. Cannot be used with <tt>:params_id_key,
:find_options</tt>, or <tt>:model</tt> if the <tt>:model</tt> option is an
instance of an ActiveRecord::Base descendent.

</dd>
<dt><tt>:params_id_key</tt></dt><dd>Parameter hash key linking to the id to be used in selecting an record to
generate timestamp or resource availability information used to identify
problem requests. Cannot be used with <tt>:id, :find_options</tt>, or
<tt>:model</tt> if the <tt>:model</tt> option is an instance of an
ActiveRecord::Base descendent.

</dd>
<dt><tt>:find_options</tt></dt><dd>Proc that evailuates to options passed to find(:first) to be used in
selecting an record to generate timestamp or resource availability
information used to identify problem requests. This needs to be a Proc
because the scope <tt><a
href="InstanceMethods.html#M000003">catch_conflicts</a></tt> <tt><a
href="InstanceMethods.html#M000004">catch_resources_unavailable</a></tt>
will be called in does not have access to the parameter hash. Ensure that
the proc returns a hash. Cannot be used with <tt>:id, :params_id_key</tt>,
or <tt>:model</tt> if the <tt>:model</tt> option is an instance of an
ActiveRecord::Base descendent.

</dd>
<dt><tt>:accessor</tt></dt><dd>Method sent to the selected record that returns the timestamp or
availability information used to identify problem requests. In <a
href="InstanceMethods.html#M000003">catch_conflicts</a> the default is
updated_at or updated_on, if such a column exists. In
catch_resource_conflicts the default is the first column with a name
matching /available/.

</dd>
<dt><tt>:template</tt></dt><dd>Template file to render in event of a conflict. For <a
href="InstanceMethods.html#M000003">catch_conflicts</a>, the default value
is &quot;#{controller_name}/#{action_name}_conflict&quot;. For
catch_resource_conflicts, the default value is
&quot;#{controller_name}/#{action_name}_resource_unavailable&quot;. When a
conflict is identified on search for a html.erb, .rhtml, or .rjs file
depending on the request. If one isn&#8216;t found the default action is
taken. The record used to generate the comparison is avaialble to template
as @#{model_name}. Where model name is the name of the model used to find
the record.

</dd>
<dt><tt>:message</tt></dt><dd>Message added to the flash hash. The <a
href="InstanceMethods.html#M000003">catch_conflicts</a> default value is
&quot;Your request will not be processed becasue the data you were viewing
is out of date. The page has been refreshed. Please try again.&quot; The
catch_resource_conflicts default value is &quot;Your request will not be
processed because the resource you require is no longer available.&quot;

</dd>
<dt><tt>:flash_key</tt></dt><dd>The flash hash key to store the message in. Default value is
<tt>:warning</tt>

</dd>
<dt><tt>&amp;block</tt></dt><dd>This block is evaulated when a problem request is identified If no block is
provided, the default action as described above is taken.

</dd>
</dl>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000003">catch_conflicts</a>&nbsp;&nbsp;
      <a href="#M000004">catch_resources_unavailable</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000003" class="method-detail">
        <a name="M000003"></a>

        <div class="method-heading">
          <a href="#M000003" class="method-signature">
          <span class="method-name">catch_conflicts</span><span class="method-args">(*args,&amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
catches requests by comparing a timestamp embedded in the parameters hash
against a record. See common options, to understand how <tt><a
href="InstanceMethods.html#M000003">catch_conflicts</a></tt> acquires a
timestamp from a record.
</p>
<p>
Using timestamps to catch conflicts is a two step process.
</p>
<p>
Step one: Embed a timestamp paramaters in potentially dangerous links. This
is easist done with the link_to_with_timestamp helper from your views. See
<tt><a
href="../../ActionView/Helpers/UrlHelper.html">ConflictWarnings::ActionView::Helpers::UrlHelper</a></tt>
and <tt>Conflict::Warnings::ActionView::Helpers::PrototypeHelper</tt> for a
list of provided helpers and their uses. <tt><a
href="InstanceMethods.html#M000003">catch_conflicts</a></tt> is expecting
the timestamp as an integer in seconds since the UNIX Epoch
</p>
<p>
Step two: Catch undesireable timestamps using <tt><a
href="InstanceMethods.html#M000003">catch_conflicts</a></tt>. The options
given are used to find a timestamp to compare against the timestamp of the
referring page. The most common uses of <tt><a
href="InstanceMethods.html#M000003">catch_conflicts</a></tt> compare the
time at which the referrant was rendered against the updated_at field on
the record to be changed. If the timestamp provided in the parameters is
deteremined to be invalid the request is interrupted.
</p>
<p>
*args are passed to the accessor. The block is optional and will be
evaluated in place of the conflict_warnings default actions when a problem
request is identified. It should contain a respond_to block.
</p>
<p>
<tt><a href="InstanceMethods.html#M000003">catch_conflicts</a></tt> accepts
three additional options to the common options described above.
</p>
<dl>
<dt><tt>:simulate_conflicts_on_requests_before</tt></dt><dd>Instead of using a record to select a timestamp for determine conflicts,
use the provide timestamp. Can be used to shut off portions of your
application at a given time. Accepts any Date,DateTime or Time object.
Cannot be used with <tt>:id, :params_id_key, :find_options</tt>, or
<tt>:model</tt> if the <tt>:model</tt> option is an instance of an
ActiveRecord::Base descendent.

</dd>
<dt><tt>:simulate_conflicts_on_requests_after</tt></dt><dd>Instead of using a record to select a timestamp for determine conflicts,
use the provide timestamp. Can be used to active portions of your
application at a given time. Accepts any Date,DateTime or Time object.
Cannot be used with <tt>:id, :params_id_key, :find_options</tt>, or
<tt>:model</tt> if the <tt>:model</tt> option is an instance of an
ActiveRecord::Base descendent.

</dd>
<dt><tt>:timestamp_key</tt></dt><dd>Parameter hash key containing the time the referring page was rendered. The
value of <tt>params[options[:timestamp_key]</tt> is compared against the
last modified time of the record selected to identify conflicts. If there
is no parameter hash key matching the value of
<tt>options[:timestamp_key]</tt> the requests is considered to be
inconflict. Default value is <tt>:page_rendered_at</tt>

</dd>
</dl>
<h4>Example</h4>
<p>
Given these views, and controller&#8230;
</p>
<h5>controllers/sample_controller_rb</h5>
<pre>
    class SampleController &lt; ApplicationController
      before_filter :only =&gt; confirm do |controller|
        controller.catch_conflicts
      end

      def confirm
       #not executed in a conflict
       ...
      end
      ...
    end
</pre>
<h4>views/sample/show.html.erb</h4>
<pre>
    &lt;div id=&quot;warnings&quot;&gt;
      &lt;/div&gt;
    &lt;div id=&quot;static_content&quot;&gt;
    ...
    &lt;/div&gt;
    &lt;div id=&quot;dynamic_content&quot;&gt;
      &lt;=%render :partial =&gt; dynamic_content%&gt;
    &lt;/div&gt;
    ...
    &lt;%=link_to_remote_with_timestamp &quot;Confirm&quot;, confirm_sample_path(@sample)%&gt;
</pre>
<h5>views/sample/confirm_conflict.rjs</h5>
<pre>
    #updates relevant portions of page and highlights changes.
    page.replace_html :warning, &quot;We cannot complete your request at this time.&quot;
    page.replace html :dynamic_content, render :partial =&gt; 'sample/dynamic_content', :locals =&gt; {:sample =&gt; @sample}
    page.visual_effect :highlight :dynamic_content, :duration =&gt; 5
</pre>
<p>
In the event that a user modifies the sample record that another user is
viewing through the show action, before that second user clicks the confirm
link. The second user&#8216;s confirmation will be interrupted and the RJS
contained in views/sample/confirm_conflict.rjs will be executed, in their
browser. Updating only a warning, the dynamic content of the show view, and
highlighting the changes.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000003-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000003-source">
<pre>
     <span class="ruby-comment cmt"># File lib/conflict_warnings.rb, line 682</span>
682:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">catch_conflicts</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>,<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
683:           <span class="ruby-identifier">options</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">extract_options!</span>
684:           <span class="ruby-identifier">options</span>.<span class="ruby-identifier">assert_valid_keys</span>(<span class="ruby-constant">CWValidKeysForCatchConflicts</span>)
685:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">send</span> <span class="ruby-identifier">:valid_options_for_conflict_warnings?</span>, <span class="ruby-identifier">:catch_conflict</span>, <span class="ruby-identifier">options</span>
686:           <span class="ruby-identifier">model</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:model</span>] <span class="ruby-operator">||</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">controller_name</span>.<span class="ruby-identifier">singularize</span>
687:           <span class="ruby-identifier">instance</span> = <span class="ruby-identifier">model</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">model</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>)
688:           <span class="ruby-identifier">model</span> = <span class="ruby-identifier">get_model</span> <span class="ruby-identifier">model</span>
689:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:simulate_conflict_on_requests_before</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span>
690:               <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:simulate_conflict_on_requests_after</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span>
691:               <span class="ruby-constant">CWInstanceSelectionKeys</span>.<span class="ruby-identifier">all?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">nil?</span>} <span class="ruby-operator">&amp;&amp;</span>
692:               [<span class="ruby-identifier">params</span>[<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:params_id_key</span>]], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>],
693:               <span class="ruby-identifier">params</span>[<span class="ruby-identifier">model</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">underscore</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;_id&quot;</span>]].<span class="ruby-identifier">all?</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">nil?</span>} <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">instance</span>.<span class="ruby-identifier">nil?</span>
694:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;catch_conflicts: You must provide a method of &quot;</span> <span class="ruby-operator">+</span>
695:               <span class="ruby-value str">&quot;generating a time used to decide which requests are fresh. Please &quot;</span> <span class="ruby-operator">+</span>
696:               <span class="ruby-value str">&quot;see redirect if conflict documentation for more details.&quot;</span>
697:           <span class="ruby-keyword kw">elsif</span> (<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:timestamp_key</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:timestamp_key</span>]].<span class="ruby-identifier">nil?</span>) <span class="ruby-operator">&amp;&amp;</span>
698:               <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:page_rendered_at</span>].<span class="ruby-identifier">nil?</span>
699:             <span class="ruby-comment cmt"># no timestamp provided</span>
700:             <span class="ruby-keyword kw">return</span>
701:             
702:           <span class="ruby-keyword kw">end</span>          
703:           <span class="ruby-identifier">redirect_requests_before</span> =
704:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:simulate_conflict_on_requests_before</span>]
705:             <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:simulate_conflict_on_requests_before</span>]
706:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:simulate_conflict_on_requests_after</span>]
707:             <span class="ruby-keyword kw">nil</span>
708:           <span class="ruby-keyword kw">else</span>
709:             <span class="ruby-identifier">accessor</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:accessor</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">model</span>.<span class="ruby-identifier">column_names</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-regexp re">/(updated_(at|on))/</span>).<span class="ruby-identifier">first</span>            
710:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">instance</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">model</span>.<span class="ruby-identifier">nil?</span>
711:               <span class="ruby-identifier">find_options</span> = {}
712:               <span class="ruby-identifier">id</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:id</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:params_id_key</span>]] <span class="ruby-operator">||</span> 
713:                 (<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:params_id_key</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">model</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">underscore</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;_id&quot;</span>] <span class="ruby-operator">||</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]))
714:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:find_options</span>]
715:                 <span class="ruby-identifier">find_options</span> = <span class="ruby-identifier">instance_eval</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">options</span>[<span class="ruby-identifier">:find_options</span>])
716:               <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">id</span>
717:                 <span class="ruby-identifier">find_options</span> = {<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">id</span>}}
718:               <span class="ruby-keyword kw">end</span>
719:               <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">find_options</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>)
720:                 <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;Find options does not evaluate to a Hash&quot;</span>
721:               <span class="ruby-keyword kw">end</span>
722:               <span class="ruby-identifier">instance</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">find_options</span>)
723:             <span class="ruby-keyword kw">end</span>
724:             <span class="ruby-identifier">instance</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">accessor</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">instance</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">accessor</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
725:           <span class="ruby-keyword kw">end</span>
726:           <span class="ruby-identifier">redirect_requests_after</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:simulate_conflict_on_requests_after</span>]
727:           <span class="ruby-identifier">timestamp_key</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:timestamp_key</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">:page_rendered_at</span>
728:           <span class="ruby-identifier">time_stamp</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">timestamp_key</span>]          
729:           <span class="ruby-identifier">flash_key</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:flash_key</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">:warning</span>
730:           <span class="ruby-identifier">message</span> = <span class="ruby-identifier">options</span> [<span class="ruby-identifier">:message</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;Your request will not be processed &quot;</span> <span class="ruby-operator">+</span>
731:             <span class="ruby-value str">&quot;because the data you were viewing is out of date. The page has &quot;</span> <span class="ruby-operator">+</span>
732:             <span class="ruby-value str">&quot;been refreshed. Please try again.&quot;</span>
733:           <span class="ruby-identifier">rendered_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span>(<span class="ruby-identifier">time_stamp</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">time_stamp</span>
734:           
735:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">rendered_at</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">rendered_at</span> <span class="ruby-operator">&amp;&amp;</span>
736:               <span class="ruby-comment cmt">#case where both are provided</span>
737:             (
738:               (<span class="ruby-identifier">redirect_requests_before</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">redirect_requests_after</span> <span class="ruby-operator">&amp;&amp;</span>
739:                   (( <span class="ruby-identifier">redirect_requests_before</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">redirect_requests_after</span> <span class="ruby-operator">&amp;&amp;</span>
740:                       ((<span class="ruby-identifier">redirect_requests_after</span><span class="ruby-operator">..</span><span class="ruby-identifier">redirect_requests_before</span>) <span class="ruby-operator">===</span> <span class="ruby-identifier">rendered_at</span>))<span class="ruby-operator">||</span>
741:                     (<span class="ruby-identifier">redirect_requests_before</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">redirect_requests_after</span> <span class="ruby-operator">&amp;&amp;</span>
742:                       <span class="ruby-operator">!</span>((<span class="ruby-identifier">redirect_requests_before</span><span class="ruby-operator">..</span><span class="ruby-identifier">redirect_requests_after</span>) <span class="ruby-operator">===</span> <span class="ruby-identifier">rendered_at</span>))
743:                 )) <span class="ruby-operator">||</span>
744:                 (
745:                 (<span class="ruby-identifier">redirect_requests_before</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">redirect_requests_after</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span>
746:                     <span class="ruby-identifier">rendered_at</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">redirect_requests_before</span>) <span class="ruby-operator">||</span>
747:                   (<span class="ruby-identifier">redirect_requests_after</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">redirect_requests_before</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span>
748:                     <span class="ruby-identifier">rendered_at</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">redirect_requests_after</span>)
749:               )
750:             )
751:             <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">flash_key</span>] = <span class="ruby-identifier">message</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">message</span>.<span class="ruby-identifier">blank?</span>
752:             <span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-node">&quot;@#{model.to_s.underscore}&quot;</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">instance</span>)
753:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">block_given?</span>
754:               <span class="ruby-identifier">instance_eval</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
755:             <span class="ruby-keyword kw">else</span>
756:               <span class="ruby-identifier">template_to_use</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:template</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">controller_name</span>, <span class="ruby-identifier">action_name</span>)
757:               <span class="ruby-identifier">template_to_use</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp re">/(_conflict)?$/</span>, <span class="ruby-value str">&quot;_conflict&quot;</span>)
758:               <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
759:                 <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> {
760:                   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">template_exists?</span>(<span class="ruby-identifier">template_to_use</span>)
761:                     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:file</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">template_to_use</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">409</span>
762:                   <span class="ruby-keyword kw">else</span>
763:                     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:back</span><span class="ruby-comment cmt">#, :status =&gt; 409</span>
764:                   <span class="ruby-keyword kw">end</span>
765:                 }
766:                 
767:                 <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span> {
768:                   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">template_exists?</span>(<span class="ruby-identifier">template_to_use</span>)
769:                     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:file</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">template_to_use</span>,  <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">409</span>
770:                   <span class="ruby-keyword kw">else</span>
771:                     <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:update</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">409</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
772:                       
773:                       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:back</span>
774:                       <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;alert('#{ escape_javascript message}')&quot;</span>
775:                     <span class="ruby-keyword kw">end</span>
776:                     
777:                   <span class="ruby-keyword kw">end</span>
778:                   <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">discard</span>(<span class="ruby-identifier">:warnings</span>)
779:                 }
780:               <span class="ruby-keyword kw">end</span>
781:             <span class="ruby-keyword kw">end</span>
782:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
783:           <span class="ruby-keyword kw">end</span>
784:           <span class="ruby-keyword kw">false</span>
785:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000004" class="method-detail">
        <a name="M000004"></a>

        <div class="method-heading">
          <a href="#M000004" class="method-signature">
          <span class="method-name">catch_resources_unavailable</span><span class="method-args">(*args,&amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
catches requests by checking a record or model for availability See common
options, to understand how <tt><a
href="InstanceMethods.html#M000004">catch_resources_unavailable</a></tt>
selects a record or model and determins availability.
</p>
<p>
Without any arguments, the model, id, and accessor are used to select the
resource. Unless options dictate otherwise, the model, is taken from the
controller name, id is from the params[:id] field, and accessor is the
first field containing the name &quot;available&quot; on the instance of
the model with the given id.
</p>
<p>
If accessor returns 0, or a false value the request is interrupted. If a
record cannot be found with the given options, then the request will
proceed without triggering the conflict action.
</p>
<p>
See the common options for other ways of specifying the deadline.
</p>
<p>
The request is interrupted if the accessor returning false, or an numeric
value less than or equal to 0.
</p>
<p>
*args are passed to the accessor. The block is optional and will be
evaluated in place of the conflict_warnings default actions when a problem
request is identified. It should contain a respond_to block.
</p>
<p>
In addition to the common options listed above, <tt><a
href="InstanceMethods.html#M000004">catch_resources_unavailable</a></tt>
also accepts the following option:
</p>
<dl>
<dt><tt>:class_method</tt></dt><dd>Default is nil. If true, accessor is treated as a class method instead of
an instance method. If a symbol or string is provided, the accessor is
ignored.

</dd>
</dl>
<h4>Example</h4>
<pre>
    class CustomFilterExampleController &lt; ApplicationController
      before_filter :check_lock

      protected
      def check_lock
        unless catch_resources_unavailable :accessor =&gt; :unlocked
          acquire_lock
        end
      end
    end
</pre>
<p>
Will interrupt a request if the record being accessed is locked.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000004-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000004-source">
<pre>
     <span class="ruby-comment cmt"># File lib/conflict_warnings.rb, line 835</span>
835:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">catch_resources_unavailable</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>,<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
836:           <span class="ruby-identifier">options</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">extract_options!</span>
837:           <span class="ruby-identifier">options</span>.<span class="ruby-identifier">assert_valid_keys</span>(<span class="ruby-constant">CWValidKeysForCatchResourcesUnavailable</span>)
838:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">send</span> <span class="ruby-identifier">:valid_options_for_conflict_warnings?</span>, <span class="ruby-identifier">:catch_resource_unavailable</span>, <span class="ruby-identifier">options</span>
839:           <span class="ruby-identifier">model</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:model</span>] <span class="ruby-operator">||</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">controller_name</span>.<span class="ruby-identifier">singularize</span>
840:           <span class="ruby-identifier">instance</span> = <span class="ruby-identifier">model</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">model</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>)
841:           <span class="ruby-identifier">model</span> = <span class="ruby-identifier">get_model</span> <span class="ruby-identifier">model</span>
842:           <span class="ruby-keyword kw">if</span> <span class="ruby-constant">CWInstanceSelectionKeys</span>.<span class="ruby-identifier">all?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">nil?</span>} <span class="ruby-operator">&amp;&amp;</span>
843:               [<span class="ruby-identifier">params</span>[<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:params_id_key</span>]], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">model</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">underscore</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;_id&quot;</span>],
844:               <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:class_method</span>]].<span class="ruby-identifier">all?</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">option</span><span class="ruby-operator">|</span>
845:               <span class="ruby-identifier">option</span>.<span class="ruby-identifier">nil?</span>} <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">instance</span>.<span class="ruby-identifier">nil?</span>
846:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;catch_resource_conflicts: You must supply a &quot;</span> <span class="ruby-operator">+</span>
847:               <span class="ruby-value str">&quot;method of determining which resource to work with. &quot;</span><span class="ruby-operator">+</span>
848:               <span class="ruby-value str">&quot;Please see redirect if resource unavailable documentation.&quot;</span>
849:           <span class="ruby-keyword kw">end</span>
850:           <span class="ruby-identifier">accessor</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:accessor</span>]
851:           <span class="ruby-identifier">accessor</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:class_method</span>]
852:           <span class="ruby-keyword kw">when</span> <span class="ruby-keyword kw">nil</span>           
853:             <span class="ruby-identifier">model</span>.<span class="ruby-identifier">column_names</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-regexp re">/(available)/</span>).<span class="ruby-identifier">first</span>
854:           <span class="ruby-keyword kw">when</span> <span class="ruby-keyword kw">true</span>
855:             <span class="ruby-identifier">model</span>.<span class="ruby-identifier">methods</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-regexp re">/available$/</span>).<span class="ruby-identifier">first</span>
856:           <span class="ruby-keyword kw">else</span>
857:             <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:class_method</span>]
858:           <span class="ruby-keyword kw">end</span>
859:           
860:           <span class="ruby-identifier">result</span> = <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:class_method</span>]
861:             <span class="ruby-identifier">model</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">accessor</span>)
862:           <span class="ruby-keyword kw">else</span>
863:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">instance</span>
864:               <span class="ruby-identifier">find_options</span> = {}
865:               <span class="ruby-identifier">id</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:id</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:params_id_key</span>]] <span class="ruby-operator">||</span>
866:                 (<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:params_id_key</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span>
867:                   (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">model</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">underscore</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;_id&quot;</span>] <span class="ruby-operator">||</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]))
868:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:find_options</span>]
869:                 <span class="ruby-identifier">find_options</span> = <span class="ruby-identifier">instance_eval</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">options</span>[<span class="ruby-identifier">:find_options</span>])
870:               <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">id</span>
871:                 <span class="ruby-identifier">find_options</span> = {<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">id</span>}}                
872:               
873:               <span class="ruby-keyword kw">end</span>
874:               <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">find_options</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>)
875:                 <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;Find options does not evaluate to a Hash&quot;</span>
876:               <span class="ruby-keyword kw">end</span>
877:               <span class="ruby-identifier">instance</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">find_options</span>)
878:             <span class="ruby-keyword kw">end</span>
879:             <span class="ruby-identifier">instance</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">accessor</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">instance</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">accessor</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
880:           <span class="ruby-keyword kw">end</span>
881:           
882:           
883:           <span class="ruby-identifier">flash_key</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:flash_key</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">:warning</span>
884:           <span class="ruby-identifier">message</span> = <span class="ruby-identifier">options</span> [<span class="ruby-identifier">:message</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;Your request will not be processed &quot;</span> <span class="ruby-operator">+</span>
885:             <span class="ruby-value str">&quot;because the resource you require is no longer available.&quot;</span>
886:           
887:           <span class="ruby-keyword kw">unless</span> (<span class="ruby-identifier">result</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Numeric</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value str">&quot;&gt;&quot;</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">result</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-operator">||</span>
888:               (<span class="ruby-operator">!</span><span class="ruby-identifier">result</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Numeric</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">result</span>)
889:             <span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-node">&quot;@#{model.to_s.underscore}&quot;</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">instance</span>)
890:             <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">flash_key</span>] = <span class="ruby-identifier">message</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">message</span>.<span class="ruby-identifier">blank?</span>
891:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">block_given?</span>
892:               <span class="ruby-identifier">instance_eval</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
893:             <span class="ruby-keyword kw">else</span>
894:               <span class="ruby-identifier">template_to_use</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:template</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">controller_name</span>, <span class="ruby-identifier">action_name</span>)
895:               <span class="ruby-identifier">template_to_use</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp re">/(_resource_unavailable)?$/</span>, <span class="ruby-value str">&quot;_resource_unavailable&quot;</span>)
896:               <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
897:                 <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> {
898:                   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">template_exists?</span>(<span class="ruby-identifier">template_to_use</span>)
899:                     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:file</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">template_to_use</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">409</span>
900:                   <span class="ruby-keyword kw">else</span>
901:                     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:back</span><span class="ruby-comment cmt">#, :status =&gt; 409</span>
902:                   <span class="ruby-keyword kw">end</span>
903:                 }
904:                 
905:                 <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span> {
906:                   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">template_exists?</span>(<span class="ruby-identifier">template_to_use</span>)
907:                     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:file</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">template_to_use</span>,  <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">409</span>
908:                   <span class="ruby-keyword kw">else</span>
909:                     <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:update</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">409</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
910:                       
911:                       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:back</span>
912:                       <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;alert('#{escape_javascript message}')&quot;</span>
913:                     <span class="ruby-keyword kw">end</span>
914:                     
915:                   <span class="ruby-keyword kw">end</span>
916:                   <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">discard</span>
917:                 }
918:               <span class="ruby-keyword kw">end</span>
919:             <span class="ruby-keyword kw">end</span>
920:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
921:           <span class="ruby-keyword kw">end</span>
922:           <span class="ruby-keyword kw">false</span>
923:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>